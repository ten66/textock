# CLAUDE.md

このファイルは、このリポジトリでコードを操作する際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

Textockは、ユーザーが動的変数を使用してテキストテンプレートを作成、整理、再利用できるReactベースのテンプレート管理アプリケーションです。このアプリは、ユーザー認証、カテゴリ分類、タグ付け、高度な検索フィルタリング、Markdownサポートなどの機能を含む、再利用可能なテキストコンテンツを管理するための包括的なソリューションを提供します。ユーザーは `{{変数名}}` 構文を使用して動的変数を含むテンプレートを作成し、生産性向上のために効率的に整理できます。

## 開発コマンド

### 基本コマンド
- `npm run dev` - 開発サーバーを起動（Vite）
- `npm run build` - 本番用ビルド
- `npm run lint` - ESLintでコード品質をチェック
- `npm run preview` - 本番ビルドをローカルでプレビュー

### 環境設定
アプリケーションには以下の環境変数が必要です：
- `VITE_SUPABASE_URL` - SupabaseプロジェクトURL
- `VITE_SUPABASE_ANON_KEY` - Supabase匿名キー

## アーキテクチャ

### コア技術
- **フロントエンド**: React 18 + TypeScript + Vite
- **スタイリング**: Tailwind CSS（ダークモードサポート、`class`戦略）
- **バックエンド**: Supabase（認証 + PostgreSQLデータベース）
- **フォーム**: React Hook Form
- **アイコン**: Lucide React
- **Markdown**: react-markdown、marked、prismjs、rehype-highlight、remark-gfm を使用した拡張テキストレンダリング

### 主要なアーキテクチャパターン

#### フックベースの状態管理
アプリは状態管理にカスタムフックを使用：
- `useAuth()` - 認証状態、サインイン/アップ/アウト操作を処理
- `useTemplates()` - テンプレートのCRUD操作とローカル状態を管理
- `useDarkMode()` - localStorageの永続化によるテーマ切り替えを管理

#### テンプレート変数システム
テンプレートは `{{変数名}}` 構文を使用した動的変数をサポート：
- `extractVariables()` - テンプレートコンテンツを解析して変数を検出
- `replaceVariables()` - 変数をユーザー提供の値で置換
- `validateTemplate()` - テンプレート構文と変数フォーマットを検証

#### コンポーネント構成
```
src/
├── components/
│   ├── auth/         # 認証フォーム（AuthForm）
│   ├── layout/       # ヘッダーとレイアウトコンポーネント
│   ├── templates/    # テンプレート固有のコンポーネント（TemplateCard、TemplateForm、TemplateUseModal）
│   └── ui/           # 再利用可能なUIコンポーネント（Button、Card、Input、Modal、MarkdownEditor、MarkdownPreviewなど）
├── hooks/            # カスタムReactフック（useAuth、useTemplates、useDarkMode）
├── lib/              # ユーティリティ関数とAPIクライアント（supabase、templateUtils、constants）
└── types/            # TypeScript型定義（Template、User、VariableDefinition）
```

### データベーススキーマ
アプリは単一の `templates` テーブルを使用：
- 行レベルセキュリティ（RLS）が有効
- ユーザーベースのアクセス制御ポリシー
- 自動的な `updated_at` タイムスタンプ更新
- 変数定義用のJSONBフィールド
- カテゴリ分類、タグ付け、公開共有のサポート
- Markdownレンダリングサポート用のオプション `is_markdown` フィールド
- テンプレート制限の実施（フリーティアでユーザーあたり30個）

### 状態フロー
1. 認証状態は `useAuth` フックで管理
2. テンプレートは `useTemplates` フックで取得・キャッシュ
3. テンプレート変数はコンテンツ変更時に自動抽出
4. すべてのデータベース操作はエラーハンドリング付きのSupabaseクライアントを経由

## 主要機能

### テンプレート管理
- **動的変数**: `{{変数名}}` 構文のサポートと自動抽出
- **Markdownサポート**: シンタックスハイライト付きのオプションMarkdownレンダリング
- **テンプレート制限**: ユーザーあたり30個（フリーティア）でカウント追跡
- **カテゴリ・タグ**: フィルタリング機能付きの整理機能
- **検索機能**: タイトル、説明、タグ全体でのリアルタイム検索
- **テンプレート使用**: 変数置換と結果生成のためのモーダルインターフェース

### ユーザーインターフェース
- **レスポンシブデザイン**: グリッドベースのテンプレート表示によるモバイルフレンドリーレイアウト
- **ダークモード**: localStorageの永続化による完全なテーマ切り替え
- **プログレッシブローディング**: スケルトン状態とローディングインジケーター
- **エラーハンドリング**: 日本語エラーメッセージによる包括的な検証
- **モーダルシステム**: フォームとテンプレート使用のための再利用可能なモーダルコンポーネント

## 開発ノート

### 日本語インターフェース
アプリケーションインターフェースは主に日本語です。エラーメッセージ、検証テキスト、UIラベルは日本語テキストを使用します。

### 変数検証
テンプレート変数は厳密なフォーマットに従う必要があります：
- 二重波括弧を使用：`{{変数名}}`
- 空の変数は無効：`{{}}` は無効
- 単一波括弧は無効：`{変数}` は無効
- 検証システムは不正な変数に対して詳細なエラーメッセージを提供

### 認証フロー
- 開発用にサインアップでのメール確認を無効化
- デバッグ用に認証状態の変更をログ出力
- ユーザーセッションはブラウザ再読み込み後も永続化
- サインアウト時にすべてのクライアント側状態をクリア

### テーマシステム
ダークモードはTailwindの `class` 戦略を使用して実装。`useDarkMode` フックがテーマ状態を管理し、document要素に `dark` クラスを適用。

### テンプレート制限
- フリーティア：ユーザーあたり最大30個（`lib/constants.ts` で定義）
- `useTemplates` フックでの制限実施
- 制限に近づいたり達したりした場合のユーザーフィードバック
- プレミアムティアでの将来的な拡張を計画

### エラーハンドリング
- 不足しているデータベースカラム（例：`is_markdown`）に対するグレースフルフォールバック
- データベース操作の再試行ロジック
- 日本語でのユーザーフレンドリーなエラーメッセージ
- デバッグ目的のコンソールログ出力